<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>QRã‚³ãƒ¼ãƒ‰ ãƒ•ãƒ©ã‚°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯</title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    video, canvas { max-width: 90%; margin: 1em auto; display: block; }
    #output, .flags { font-size: 1.1em; margin: 1em; }
    .unlocked { color: green; font-weight: bold; }
    .locked { color: gray; }
    button { padding: 0.5em 1em; font-size: 1em; margin: 0.5em; }
  </style>
</head>
<body>
  <h2>ğŸ“· QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ & ãƒ•ãƒ©ã‚°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯</h2>
  <video id="video" autoplay muted></video>
  <canvas id="canvas" hidden></canvas>
  <div id="output">èª­ã¿å–ã‚Šå¾…æ©Ÿä¸­...</div>
  <button id="restartBtn">ğŸ”„ å†èª­ã¿å–ã‚Š</button>

  <div class="flags">
    <div id="flag1" class="locked">ãƒ•ãƒ©ã‚°1ï¼šğŸ”’</div>
    <div id="flag2" class="locked">ãƒ•ãƒ©ã‚°2ï¼šğŸ”’</div>
    <div id="flag3" class="locked">ãƒ•ãƒ©ã‚°3ï¼šğŸ”’</div>
    <div id="allFlags" class="locked">å…¨ãƒ•ãƒ©ã‚°è§£é™¤æ¸ˆï¼šğŸ”’</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const output = document.getElementById('output');
    const restartBtn = document.getElementById('restartBtn');

    let scanning = true;
    const unlockedFlags = {
      flag1: false,
      flag2: false,
      flag3: false,
    };

    const flagCodes = {
      "y5PjW6zf": "flag1",
      "Ry8gxiaL": "flag2",
      "hW8PZaQS": "flag3",
      "Uh6H9uwd": "cheat",  // å…¨è§£é™¤ãƒãƒ¼ãƒˆ
      "V3k6Fhfb": "reset"
    };

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(stream => {
        video.srcObject = stream;
        video.setAttribute("playsinline", true);
        requestAnimationFrame(tick);
      })
      .catch(err => {
        output.textContent = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err;
      });

    function tick() {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          handleCode(code.data.trim());
          scanning = false;
          return;
        } else {
          output.textContent = "QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...";
        }
      }
      requestAnimationFrame(tick);
    }

    function handleCode(data) {
      output.textContent = "èª­ã¿å–ã£ãŸã‚³ãƒ¼ãƒ‰: " + data;
      const flagKey = flagCodes[data];
      if (flagKey === "reset") {
        resetFlags();
      } else if (flagKey === "cheat") {
        cheatUnlock();
      } else if (flagKey) {
        unlockFlag(flagKey);
      } else {
        output.textContent += "ï¼ˆç„¡åŠ¹ãªã‚³ãƒ¼ãƒ‰ï¼‰";
      }
    }

    function unlockFlag(flagKey) {
      if (!unlockedFlags[flagKey]) {
        unlockedFlags[flagKey] = true;
        const el = document.getElementById(flagKey);
        el.textContent = `${el.textContent.split("ï¼š")[0]}ï¼šâœ…`;
        el.className = "unlocked";
        checkAllFlags();
      } else {
        output.textContent += "ï¼ˆã™ã§ã«è§£é™¤æ¸ˆã¿ï¼‰";
      }
    }

    function cheatUnlock() {
      for (let key in unlockedFlags) {
        unlockedFlags[key] = true;
        const el = document.getElementById(key);
        el.textContent = `ãƒ•ãƒ©ã‚°${key.slice(-1)}ï¼šâœ…`;
        el.className = "unlocked";
      }
      document.getElementById("allFlags").textContent = "å…¨ãƒ•ãƒ©ã‚°è§£é™¤æ¸ˆï¼šâœ…ï¼ˆãƒãƒ¼ãƒˆï¼‰";
      document.getElementById("allFlags").className = "unlocked";
      output.textContent += "ï¼ˆãƒãƒ¼ãƒˆã§å…¨ãƒ•ãƒ©ã‚°è§£é™¤ï¼‰";
    }

    function checkAllFlags() {
      if (
        unlockedFlags.flag1 &&
        unlockedFlags.flag2 &&
        unlockedFlags.flag3
      ) {
        document.getElementById("allFlags").textContent = "å…¨ãƒ•ãƒ©ã‚°è§£é™¤æ¸ˆï¼šâœ…";
        document.getElementById("allFlags").className = "unlocked";
      }
    }

    function resetFlags() {
      for (let key in unlockedFlags) unlockedFlags[key] = false;
      ["flag1", "flag2", "flag3"].forEach(id => {
        const el = document.getElementById(id);
        el.textContent = `ãƒ•ãƒ©ã‚°${id.slice(-1)}ï¼šğŸ”’`;
        el.className = "locked";
      });
      const allEl = document.getElementById("allFlags");
      allEl.textContent = "å…¨ãƒ•ãƒ©ã‚°è§£é™¤æ¸ˆï¼šğŸ”’";
      allEl.className = "locked";
      output.textContent = "ğŸ”„ ãƒ•ãƒ©ã‚°çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ";
    }

    restartBtn.addEventListener("click", () => {
      output.textContent = "å†ã‚¹ã‚­ãƒ£ãƒ³ä¸­...";
      scanning = true;
      requestAnimationFrame(tick);
    });
  </script>
</body>
</html>
